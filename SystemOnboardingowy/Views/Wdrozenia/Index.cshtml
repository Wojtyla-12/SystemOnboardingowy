@model IEnumerable<SystemOnboardingowy.Models.Wdrozenie>

@{
    ViewData["Title"] = "Wdrożenia";
    bool pokazZakonczone = (bool?)ViewData["PokazZakonczone"] ?? false;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Lista Wdrożeń</h1>
    @if (User.IsInRole("Kierownik"))
    {
        <a asp-action="Create" class="btn btn-primary">➕ Nowe Wdrożenie</a>
    }
</div>

<form asp-action="Index" method="get" class="card p-3 mb-4 bg-dark table-bordered">
    <div class="row g-3 align-items-center">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-info">🔍</span>
                <input type="text" name="searchString" class="form-control" placeholder="Szukaj pracownika..." value="@ViewData["CurrentFilter"]">
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-check pt-2">
                <a href="@Url.Action("Index", new { pokazZakonczone = !(bool)ViewData["PokazZakonczone"] })" class="btn btn-outline-secondary btn-sm">
                    @((bool)ViewData["PokazZakonczone"] ? "👁️ Ukryj zakończone" : "📜 Pokaż archiwum")
                </a>
            </div>
        </div>
        <div class="col-md-3 text-end">
            <button type="submit" class="btn btn-secondary w-100">Filtruj</button>
        </div>
    </div>
</form>
    <div>

        @if (User.IsInRole("Kierownik"))
        {
            <a asp-action="Create" class="btn btn-primary ms-2">➕ Nowy Ticket</a>
        }
    </div>
</div>

<div class="row">
    @foreach (var item in Model)
    {
        // Sprawdzamy zadania używając nowych nazw właściwości (z.Dzial zamiast z.DzialOdpowiedzialny)
        var działyNiewykonane = item.Zadania.Where(z => !z.CzyWykonane).Select(z => z.Dzial).Distinct().ToList();

        bool pilneDlaMnie = false;
        if (User.IsInRole("IT") && działyNiewykonane.Contains(SystemOnboardingowy.Models.Dzial.IT)) pilneDlaMnie = true;
        if (User.IsInRole("HR") && działyNiewykonane.Contains(SystemOnboardingowy.Models.Dzial.HR)) pilneDlaMnie = true;
        if (User.IsInRole("Sprzet") && działyNiewykonane.Contains(SystemOnboardingowy.Models.Dzial.Sprzet)) pilneDlaMnie = true;

        <div class="col-12 col-md-10 col-lg-8 mx-auto mb-3">
            <div class="card @(pilneDlaMnie ? "border-danger border-1 shadow" : "border-secondary")" style="background-color: #1e1e1e; color: #fff;">
                <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
                    <div style="min-width: 200px;">
                        <h5 class="card-title mb-1">
                            @item.Pracownik?.Imie @item.Pracownik?.Nazwisko
                            
                            @if (item.Status == SystemOnboardingowy.Models.StatusZgloszenia.Anulowane)
                            {
                                <span class="badge bg-danger ms-2">ANULOWANE</span>
                            }
                        </h5>
                        <p class="card-text text-muted small mb-0">Zgłoszono: @item.DataUtworzenia.ToString("dd.MM HH:mm")</p>
                    </div>
                    <div class="d-flex gap-2 my-2">
                        @if (item.Status == SystemOnboardingowy.Models.StatusZgloszenia.Zakonczone)
                        {
                            <span class="badge bg-success p-2">ZAKOŃCZONE</span>
                        }
                        else if (item.Status != SystemOnboardingowy.Models.StatusZgloszenia.Anulowane)
                        {
                            @if (działyNiewykonane.Contains(SystemOnboardingowy.Models.Dzial.HR))
                            {
                                <span class="badge bg-danger p-2">HR</span>
                            }
                            else
                            {

                                <span class="badge bg-success border border-secondary p-2">HR OK</span>
                            }
                            @if (działyNiewykonane.Contains(SystemOnboardingowy.Models.Dzial.IT))
                            {
                                <span class="badge bg-info text-dark p-2">IT</span>
                            }
                            else
                            {

                                <span class="badge bg-success border border-secondary p-2">IT OK</span>
                            }
                            @if (działyNiewykonane.Contains(SystemOnboardingowy.Models.Dzial.Sprzet))
                            {
                                <span class="badge bg-warning text-dark p-2">Sprzęt</span>
                            }
                            else
                            {

                                <span class="badge bg-success border border-secondary p-2">Sprzęt OK</span>
                            }
                        }
                    </div>
                    <div><a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-light">Szczegóły ➡️</a></div>
                </div>
            </div>
        </div>
    }
</div>