@model IEnumerable<SystemOnboardingowy.Models.ZadanieWdrozeniowe>

@{
    ViewData["Title"] = "Moje Zadania";
}

<h2 class="mb-4">📋 Moje Zadania (Do wykonania)</h2>

@if (!Model.Any())
{
    <div class="alert alert-success shadow-sm">
        🎉 Brak zaległych zadań! Wszystko zrobione.
    </div>
}
else
{
    @foreach (var grupa in Model.GroupBy(x => x.Wdrozenie?.PracownikId ?? x.Odejscie?.PracownikId))
    {
        var pierwszyElement = grupa.First();
        var pracownik = pierwszyElement.Wdrozenie?.Pracownik ?? pierwszyElement.Odejscie?.Pracownik;
        var stanowisko = pierwszyElement.Wdrozenie?.Stanowisko.ToString() ?? pierwszyElement.Odejscie?.Pracownik?.Stanowisko.ToString();

        <div class="card mb-4 shadow border-secondary" style="background-color: #1e1e1e;">
            <div class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center" style="background-color: #2b2b2b;">
                <div>
                    <h4 class="mb-0 text-white">👤 @pracownik?.ImieNazwisko</h4>
                    <small class="text-muted">Stanowisko: @stanowisko</small>
                </div>
                <span class="badge bg-primary rounded-pill">Zadań: @grupa.Count()</span>
            </div>

            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0" style="background-color: #1e1e1e; color: #e0e0e0;">
                    <thead style="border-bottom: 1px solid #444;">
                        <tr>
                            <th style="width: 15%;">Proces</th>
                            <th style="width: 50%;">Zadanie</th>
                            <th style="width: 20%;">Termin</th>
                            <th style="width: 15%;" class="text-end">Akcja</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in grupa)
                        {
                            <tr style="border-bottom: 1px solid #333;">
                                <td>
                                    @if (item.Wdrozenie != null)
                                    {
                                        <span class="badge bg-success bg-opacity-75">🚀 Wdrożenie</span>
                                    }
                                    else if (item.Odejscie != null)
                                    {
                                        <span class="badge bg-danger bg-opacity-75">🚪 Odejście</span>
                                    }
                                </td>

                                <td>
                                    <span class="fw-bold">@item.Tresc</span>
                                </td>

                                <td>
                                    @if (item.Wdrozenie != null)
                                    {
                                        var dni = (item.Wdrozenie.DataRozpoczeciaPracy - DateTime.Now).TotalDays;
                                        <span class="@(dni < 2 ? "text-danger fw-bold" : "text-light")">
                                            Start: @item.Wdrozenie.DataRozpoczeciaPracy.ToString("dd.MM HH:mm")
                                        </span>
                                    }
                                    else if (item.Odejscie != null)
                                    {
                                        var dni = (item.Odejscie.DataOdejscia - DateTime.Now).TotalDays;
                                        <span class="@(dni < 2 ? "text-danger fw-bold" : "text-light")">
                                            Koniec: @item.Odejscie.DataOdejscia.ToString("dd.MM.yyyy")
                                        </span>
                                    }
                                </td>

                                <td class="text-end">
                                    <form asp-action="WykonajZadanie" method="post" class="d-inline">
                                        <input type="hidden" name="zadanieId" value="@item.Id" />
                                        <button type="submit" class="btn btn-success btn-sm" title="Oznacz jako wykonane">
                                            ✅ Gotowe
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}